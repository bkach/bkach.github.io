<!DOCTYPE html>
<html>
<head>
    <title>Income & Tax Calculator</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">Income & Tax Calculator for Therapists</h1>
        <div class="form-group">
            <label for="sessionList">Session Prices:</label>
            <div id="sessionList"></div>
            <button class="btn btn-primary mt-2" id="addSession">Add Price</button>
        </div>
        <div class="form-group">
            <label for="cancellationRate">Cancellation Rate (%):</label>
            <input type="number" class="form-control" id="cancellationRate" value="30">
        </div>
        <div class="form-group">
            <label for="weeksOffPerYear">Weeks Off per Year:</label>
            <input type="number" class="form-control" id="weeksOffPerYear">
        </div>
        <div class="form-group">
            <label for="taxRate">Tax Rate (%):</label>
            <input type="number" class="form-control" id="taxRate" value="30">
        </div>
        <div class="form-group">
            <label for="expenses">Expenses per year (£):</label>
            <input type="number" class="form-control" id="expenses">
        </div>
        <button class="btn btn-success" id="calculate">Calculate</button>
        <button class="btn btn-secondary" id="clearAll">Clear All</button>
        <table id="resultTable" class="table table-bordered mt-4" style="display: none">
            <thead>
                <tr>
                    <th scope="col">Income</th>
                    <th scope="col">Tax</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="incomeCell"></td>
                    <td id="taxCell"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        const storageKey = 'therapistCalculator';
        let priceCount = 0;
        function addSessionPrice(price = '', amount = '') {
            const sessionPrice = $('<input>', {
                type: 'number',
                id: `price${priceCount}`,
                placeholder: 'Price per session (£)',
                class: 'form-control my-2',
                value: price
            });
            const sessionAmount = $('<input>', {
                type: 'number',
                id: `amount${priceCount}`,
                placeholder: 'Number of clients per week at this price',
                class: 'form-control my-2',
                value: amount
            });
            const removeButton = $('<button>', {
                text: 'Remove',
                class: 'btn btn-danger my-2',
                click: function () {
                    sessionPrice.remove();
                    sessionAmount.remove();
                    $(this).remove();
                    saveToLocalStorage();
                }
            });
            $('#sessionList').append(sessionPrice, sessionAmount, removeButton);
            priceCount++;
        }
        function saveToLocalStorage() {
            const calculatorData = {
                prices: _.range(priceCount).map(i => {
                    const priceElement = $(`#price${i}`);
                    const amountElement = $(`#amount${i}`);
                    return priceElement.length && amountElement.length ? {
                        price: priceElement.val(),
                        amount: amountElement.val()
                    } : null;
                }).filter(Boolean),
                cancellationRate: $('#cancellationRate').val(),
                weeksOffPerYear: $('#weeksOffPerYear').val(),
                taxRate: $('#taxRate').val(),
                expenses: $('#expenses').val()
            };

            try {
                localStorage.setItem(storageKey, JSON.stringify(calculatorData));
            } catch (e) {
                console.warn('Failed to save data to localStorage.');
            }
        }
        $(document).ready(function () {
            $('#clearAll').on('click', function () {
                // Clear all input fields
                $('input').val('');
                
                $('#resultTable').hide(); // hide the results table
                $('#incomeCell').text(''); // clear the income cell
                $('#taxCell').text(''); // clear the tax cell

                // Remove all session price inputs
                $('#sessionList').empty();
                priceCount = 0;

                // Clear local storage
                try {
                    localStorage.removeItem(storageKey);
                } catch (e) {
                    console.warn('Failed to clear data from localStorage.');
                }
            });

            $('#addSession').on('click', function () {
                addSessionPrice();
            });

            $('#calculate').on('click', function () {
                let yearlyIncome = 0;
                let yearlyTax = 0;

                for (let i = 0; i < priceCount; i++) {
                    const price = parseFloat($(`#price${i}`).val()) || 0;
                    const amount = parseFloat($(`#amount${i}`).val()) || 0;
                    yearlyIncome += price * amount;
                }

                const cancellationRate = parseFloat($('#cancellationRate').val()) / 100 || 0;
                const weeksOffPerYear = parseFloat($('#weeksOffPerYear').val()) || 0;
                const taxRate = parseFloat($('#taxRate').val()) / 100 || 0;
                const expenses = parseFloat($('#expenses').val()) || 0;

                const weeksPerYear = 52 - weeksOffPerYear;
                yearlyIncome *= weeksPerYear * (1 - cancellationRate);
                yearlyIncome = yearlyIncome - expenses;
                yearlyTax = yearlyIncome * taxRate;

                $('#resultTable').show();
                $('#incomeCell').text(`£${parseFloat(yearlyIncome).toLocaleString('en-UK', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
                $('#taxCell').text(`£${parseFloat(yearlyTax).toLocaleString('en-UK', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);

                saveToLocalStorage();
            });

            try {
                const savedData = JSON.parse(localStorage.getItem(storageKey));
                if (savedData) {
                    savedData.prices.forEach(({ price, amount }) => addSessionPrice(price, amount));
                    $('#cancellationRate').val(savedData.cancellationRate);
                    $('#weeksOffPerYear').val(savedData.weeksOffPerYear);
                    $('#taxRate').val(savedData.taxRate);
                    $('#expenses').val(savedData.expenses);
                }
            } catch (e) {
                console.warn('Failed to load data from localStorage.');
            }
            });
    </script>
</body>
</html>
