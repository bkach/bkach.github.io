<!DOCTYPE html>
<html>
<head>
    <title>Income & Tax Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .form-group {
            margin-bottom: 1.5rem;
        }
        .btn {
            margin-bottom: 1rem;
        }
        #sessionResultsTable {
            margin-top: 1rem;
        }
        .inputs-table td {
            padding: 0.25rem;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .highlight-row {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">Income & Tax Calculator for Therapists</h1>
        <div class="form-group">
            <label for="sessionList">Session Prices:</label>
            <div id="sessionList"></div>
            <button class="btn btn-primary mt-2" id="addSession">Add Price</button>
        </div>
        <div class="form-group">
            <label for="cancellationRate">Cancellation Rate (%):</label>
            <input type="number" class="form-control" id="cancellationRate" value="30">
        </div>
        <div class="form-group">
            <label for="weeksOffPerYear">Weeks Off per Year:</label>
            <input type="number" class="form-control" id="weeksOffPerYear">
        </div>
        <div class="form-group">
            <label for="taxRate">Tax Rate (%):</label>
            <input type="number" class="form-control" id="taxRate" value="30">
        </div>
        <div class="form-group">
            <label for="expenses">Expenses per year (£):</label>
            <input type="number" class="form-control" id="expenses">
        </div>
        <button class="btn btn-success" id="calculate">Calculate</button>
        <button class="btn btn-secondary" id="clearAll">Clear All</button>
        <table class="table mt-4" id="sessionResultsTable" style="display: none;">
            <caption>Tap on a row to see the inputs</caption>
            <thead>
                <tr>
                    <th scope="col">Income (£)</th>
                    <th scope="col">Tax (£)</th>
                </tr>
            </thead>
            <tbody id="sessionResults"></tbody>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        const storageKey = 'therapistCalculator';
        let priceCount = 0;
        let sessionResults = [];
        function addSessionPrice(price = '', amount = '') {
            const sessionPrice = $('<input>', {
                type: 'number',
                id: `price${priceCount}`,
                placeholder: 'Price per session (£)',
                class: 'form-control my-2',
                value: price
            });
            const sessionAmount = $('<input>', {
                type: 'number',
                id: `amount${priceCount}`,
                placeholder: 'Number of clients per week at this price',
                class: 'form-control my-2',
                value: amount
            });
            const removeButton = $('<button>', {
                text: 'Remove',
                class: 'btn btn-danger my-2',
                click: function () {
                    sessionPrice.remove();
                    sessionAmount.remove();
                    $(this).remove();
                    saveToLocalStorage();
                }
            });
            $('#sessionList').append(sessionPrice, sessionAmount, removeButton);
            priceCount++;
        }
        function saveToLocalStorage() {
            const calculatorData = {
                prices: _.range(priceCount).map(i => {
                    const priceElement = $(`#price${i}`);
                    const amountElement = $(`#amount${i}`);
                    return priceElement.length && amountElement.length ? {
                        price: priceElement.val(),
                        amount: amountElement.val()
                    } : null;
                }).filter(Boolean),
                cancellationRate: $('#cancellationRate').val(),
                weeksOffPerYear: $('#weeksOffPerYear').val(),
                taxRate: $('#taxRate').val(),
                expenses: $('#expenses').val()
            };

            try {
                localStorage.setItem(storageKey, JSON.stringify(calculatorData));
            } catch (e) {
                console.warn('Failed to save data to localStorage.');
            }
        }
        $(document).ready(function () {
            $('#clearAll').on('click', function () {
                // Clear all input fields
                $('input').val('');

                // Remove all session price inputs
                $('#sessionList').empty();
                priceCount = 0;

                // Clear local storage
                try {
                    localStorage.removeItem(storageKey);
                } catch (e) {
                    console.warn('Failed to clear data from localStorage.');
                }
            });

            $('#addSession').on('click', function () {
                addSessionPrice();
            });

            $('#calculate').on('click', function () {
                let yearlyIncome = 0;
                let yearlyTax = 0;

                for (let i = 0; i < priceCount; i++) {
                    const price = parseFloat($(`#price${i}`).val()) || 0;
                    const amount = parseFloat($(`#amount${i}`).val()) || 0;
                    yearlyIncome += price * amount;
                }

                const cancellationRate = parseFloat($('#cancellationRate').val()) / 100 || 0;
                const weeksOffPerYear = parseFloat($('#weeksOffPerYear').val()) || 0;
                const taxRate = parseFloat($('#taxRate').val()) / 100 || 0;
                const expenses = parseFloat($('#expenses').val()) || 0;

                const weeksPerYear = 52 - weeksOffPerYear;
                yearlyIncome *= weeksPerYear * (1 - cancellationRate);
                yearlyIncome = yearlyIncome - expenses;
                yearlyTax = yearlyIncome * taxRate;

                let inputs = {
                    prices: _.range(priceCount).map(i => ({
                        price: $(`#price${i}`).val(),
                        amount: $(`#amount${i}`).val()
                    })),
                    cancellationRate: $('#cancellationRate').val(),
                    weeksOffPerYear: $('#weeksOffPerYear').val(),
                    taxRate: $('#taxRate').val(),
                    expenses: $('#expenses').val()
                };

                // Prepare inputs text
                let inputsText = inputs.prices.map((session, index) => `Session ${index+1}: Price - £${parseFloat(session.price).toLocaleString('en-UK', {minimumFractionDigits: 2})}, Amount - ${session.amount}`).join(", ") +
                    `, Cancellation Rate: ${inputs.cancellationRate}%, Weeks Off per Year: ${inputs.weeksOffPerYear}, Tax Rate: ${inputs.taxRate}%, Expenses: £${parseFloat(inputs.expenses).toLocaleString('en-UK', {minimumFractionDigits: 2})}`;

                // Prepare new row
                let timestamp = Date.now();

                // Prepare inputs table
                let inputsTable = inputs.prices.map((session, index) => `
                <tr>
                    <td>Session ${index+1}:</td>
                    <td>Price - £${parseFloat(session.price).toLocaleString('en-UK', {minimumFractionDigits: 2})},</td>
                    <td>Amount - ${session.amount}</td>
                </tr>
                `).join("");

                inputsTable += `
                <tr>
                    <td>Cancellation Rate:</td>
                    <td colspan="2">${inputs.cancellationRate}%</td>
                </tr>
                <tr>
                    <td>Weeks Off per Year:</td>
                    <td colspan="2">${inputs.weeksOffPerYear}</td>
                </tr>
                <tr>
                    <td>Tax Rate:</td>
                    <td colspan="2">${inputs.taxRate}%</td>
                </tr>
                <tr>
                    <td>Expenses:</td>
                    <td colspan="2">£${parseFloat(inputs.expenses).toLocaleString('en-UK', {minimumFractionDigits: 2})}</td>
                </tr>
                `;

                let newRow = `
                <tr class="cursor-pointer ${sessionResults.length === 0 ? 'highlight-row' : ''}" data-toggle="collapse" data-target="#inputs${timestamp}">                
                    <td>£${parseFloat(yearlyIncome.toFixed(2)).toLocaleString('en-UK', {minimumFractionDigits: 2})}</td>
                    <td>£${parseFloat(yearlyTax.toFixed(2)).toLocaleString('en-UK', {minimumFractionDigits: 2})}</td>
                </tr>
                <tr id="inputs${timestamp}" class="collapse">
                    <td colspan="2">
                        <table class="table table-sm inputs-table">
                            ${inputsTable}
                        </table>
                    </td>
                </tr>
                `;

                // Prepend the new row to session results table
                $("#sessionResults").prepend(newRow);

                // Remove the highlight class from all rows except the first one
                $("#sessionResults").children().removeClass('highlight-row');
                $("#sessionResults").children().first().addClass('highlight-row');

                $("#sessionResultsTable").show(); // Show the table if it's not visible

                saveToLocalStorage();
            });

            try {
                const savedData = JSON.parse(localStorage.getItem(storageKey));
                if (savedData) {
                    savedData.prices.forEach(({ price, amount }) => addSessionPrice(price, amount));
                    $('#cancellationRate').val(savedData.cancellationRate);
                    $('#weeksOffPerYear').val(savedData.weeksOffPerYear);
                    $('#taxRate').val(savedData.taxRate);
                    $('#expenses').val(savedData.expenses);
                }
            } catch (e) {
                console.warn('Failed to load data from localStorage.');
            }
        });
    </script>
</body>
</html>
